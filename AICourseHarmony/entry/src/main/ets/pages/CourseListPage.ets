// è¯¾ç¨‹åˆ—è¡¨é¡µé¢ï¼Œæ”¯æŒè¯¾ç¨‹çš„ç­›é€‰ã€æœç´¢ã€ç®¡ç†ç­‰åŠŸèƒ½
import router from '@ohos.router';
import { getCurrentUser } from '../common/UserStore';
import { UserInfo } from '../common/UserTypes';
import { getEnrolledCourses, getAllCourses, getCoursesByTeacher, enrollCourse } from '../common/CourseStore';
import { Course } from '../common/CourseTypes';

/**
 * è¯¾ç¨‹åˆ—è¡¨é¡µé¢ç»„ä»¶
 * å±•ç¤ºæ‰€æœ‰è¯¾ç¨‹ï¼Œæ”¯æŒç­›é€‰ã€æœç´¢ã€ç®¡ç†ç­‰æ“ä½œ
 */
@Entry
@Component
struct CourseListPage {
  /** å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ */
  @State currentUser: UserInfo | null = getCurrentUser();
  /** å…¨éƒ¨è¯¾ç¨‹æ•°æ®ï¼ˆç”¨äºç­›é€‰ï¼‰ */
  @State allCourses: Course[] = [];
  /** å½“å‰ç­›é€‰/æœç´¢åçš„è¯¾ç¨‹æ•°æ® */
  @State courses: Course[] = [];
  /** æœç´¢å…³é”®è¯ */
  @State searchText: string = '';
  /** å½“å‰é€‰ä¸­çš„å­¦é™¢å’Œç±»åˆ« */
  @State selectedDepartment: string = 'all';
  @State selectedCategory: string = 'all';
  /** åŠ è½½çŠ¶æ€ */
  @State isLoading: boolean = false;

  aboutToAppear() {
    if (!this.currentUser) {
      router.replaceUrl({ url: 'pages/LoginPage' });
      return;
    }
    this.loadCourses();
  }

  /**
   * é¡µé¢æ¯æ¬¡æ˜¾ç¤ºæ—¶è‡ªåŠ¨åˆ·æ–°è¯¾ç¨‹æ•°æ®
   */
  onShow() {
    this.loadCourses();
  }

  /**
   * åŠ è½½å…¨éƒ¨è¯¾ç¨‹æ•°æ®ï¼Œå¹¶æ ¹æ®ç­›é€‰æ¡ä»¶åˆ·æ–°æ˜¾ç¤º
   */
  loadCourses() {
    this.isLoading = true;
    setTimeout(() => {
      // ç»Ÿä¸€ä»å…¨å±€CourseStoreè·å–æ‰€æœ‰è¯¾ç¨‹
      this.allCourses = getAllCourses();
      this.filterCourses();
      this.isLoading = false;
    }, 500);
  }

  /**
   * é¡µé¢ä¸»ç»“æ„
   */
  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button('â† è¿”å›')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            router.back();
          })
        
        Text('è¯¾ç¨‹åˆ—è¡¨')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .flexGrow(1)
          .textAlign(TextAlign.Center)
        
        Button('+ æ–°å»º')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            // TODO: è·³è½¬åˆ°æ–°å»ºè¯¾ç¨‹é¡µé¢
          })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 20, bottom: 20 })
      .backgroundColor(Color.White)
      .border({ width: { bottom: 1 }, color: '#e0e0e0' })

      // æœç´¢å’ŒåŒé‡ç­›é€‰
      this.buildSearchAndDoubleFilter()
      
      // è¯¾ç¨‹åˆ—è¡¨å¯æ»šåŠ¨
      Scroll() {
        this.buildCourseList()
      }
      .flexGrow(1)
      .width('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  /**
   * æœç´¢ä¸åŒé‡ç­›é€‰åŒºåŸŸ
   */
  @Builder
  buildSearchAndDoubleFilter() {
    Column() {
      // æœç´¢æ¡†
      Row() {
        TextInput({ 
          placeholder: 'æœç´¢è¯¾ç¨‹åç§°æˆ–æ•™å¸ˆ', 
          text: this.searchText 
        })
          .onChange((value: string) => {
            this.searchText = value;
            this.filterCourses();
          })
          .width('85%')
          .height(40)
          .backgroundColor('#f8f9fa')
          .borderRadius(20)
          .padding({ left: 15, right: 15 })
          .placeholderColor('#999')
        Button('ğŸ”')
          .width('15%')
          .height(40)
          .backgroundColor('#007AFF')
          .borderRadius(20)
          .fontColor(Color.White)
          .onClick(() => {
            this.filterCourses();
          })
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
      .margin({ bottom: 10 })

      // å­¦é™¢ç­›é€‰Tab
      Scroll() {
        Row() {
          this.buildDepartmentChip('å…¨éƒ¨å­¦é™¢', 'all')
          ForEach(this.getAllDepartments(), (dep: string) => this.buildDepartmentChip(dep, dep))
        }
        .padding({ left: 20, right: 20 })
      }
      .scrollable(ScrollDirection.Horizontal)
      .margin({ bottom: 10 })

      // ç±»åˆ«ç­›é€‰Tab
      Scroll() {
        Row() {
          this.buildCategoryChip('å…¨éƒ¨ç±»åˆ«', 'all')
          ForEach(this.getAllCategories(), (cat: string) => this.buildCategoryChip(cat, cat))
        }
        .padding({ left: 20, right: 20 })
      }
      .scrollable(ScrollDirection.Horizontal)
      .margin({ bottom: 10 })
    }
    .padding({ left: 20, right: 20, top: 15 })
    .backgroundColor(Color.White)
  }

  /**
   * è·å–æ‰€æœ‰å­¦é™¢å’Œç±»åˆ«ï¼ˆç”¨äºç­›é€‰Tabï¼‰
   */
  getAllDepartments(): string[] {
    const deps = this.allCourses.map(c => c.department).filter(dep => !!dep);
    return Array.from(new Set(deps));
  }
  getAllCategories(): string[] {
    const cats = this.allCourses.map(c => c.category).filter(cat => !!cat);
    return Array.from(new Set(cats));
  }

  @Builder
  buildDepartmentChip(label: string, value: string) {
    Button(label)
      .fontSize(14)
      .height(32)
      .backgroundColor(this.selectedDepartment === value ? '#007AFF' : '#f0f0f0')
      .fontColor(this.selectedDepartment === value ? Color.White : '#333')
      .borderRadius(16)
      .margin({ right: 10 })
      .onClick(() => {
        this.selectedDepartment = value;
        this.filterCourses();
      })
  }
  @Builder
  buildCategoryChip(label: string, value: string) {
    Button(label)
      .fontSize(14)
      .height(32)
      .backgroundColor(this.selectedCategory === value ? '#007AFF' : '#f0f0f0')
      .fontColor(this.selectedCategory === value ? Color.White : '#333')
      .borderRadius(16)
      .margin({ right: 10 })
      .onClick(() => {
        this.selectedCategory = value;
        this.filterCourses();
      })
  }

  /**
   * è¯¾ç¨‹åˆ—è¡¨æ¸²æŸ“
   */
  @Builder
  buildCourseList() {
    if (this.isLoading) {
      Column() {
        LoadingProgress()
          .width(50)
          .height(50)
          .margin({ top: 100 })
        
        Text('åŠ è½½ä¸­...')
          .fontSize(14)
          .fontColor('#666')
          .margin({ top: 10 })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
    } else if (this.courses.length === 0) {
      Column() {
        Text('ğŸ“š')
          .fontSize(60)
          .margin({ top: 100, bottom: 20 })
        
        Text('æš‚æ— è¯¾ç¨‹')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .margin({ bottom: 10 })
        
        Text('æ‚¨è¿˜æ²¡æœ‰ä»»ä½•è¯¾ç¨‹')
          .fontSize(14)
          .fontColor('#666')
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
    } else {
      List() {
        ForEach(this.courses, (course: Course) => {
          ListItem() {
            this.buildCourseItem(course)
          }
        })
      }
      .width('100%')
      .height('100%')
      .padding({ left: 20, right: 20 })
    }
  }

  /**
   * å•ä¸ªè¯¾ç¨‹å¡ç‰‡æ¸²æŸ“
   */
  @Builder
  buildCourseItem(course: Course) {
    Column() {
      Row() {
        // è¯¾ç¨‹å°é¢
        Image(course.coverImage || $r('app.media.foreground'))
          .width(80)
          .height(60)
          .borderRadius(8)
          .backgroundColor('#f0f0f0')
        // è¯¾ç¨‹ä¿¡æ¯
        Column() {
          Text(course.name)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .margin({ bottom: 5 })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
          Text(course.description)
            .fontSize(14)
            .fontColor('#666')
            .margin({ bottom: 5 })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
          Row() {
            Text(course.teacherName)
              .fontSize(12)
              .fontColor('#999')
            Text('â€¢')
              .fontSize(12)
              .fontColor('#999')
              .margin({ left: 8, right: 8 })
            Text(`${course.enrolledCount}äººå­¦ä¹ `)
              .fontSize(12)
              .fontColor('#999')
            Text('â€¢')
              .fontSize(12)
              .fontColor('#999')
              .margin({ left: 8, right: 8 })
            Text('äººå·¥æ™ºèƒ½')
              .fontSize(12)
              .fontColor('#999')
          }
        }
        .alignItems(HorizontalAlign.Start)
        .flexGrow(1)
        .margin({ left: 15 })
      }
      .width('100%')
      // åº•éƒ¨æ“ä½œæŒ‰é’®ç»„æ¨ªå‘æ’åˆ—
      Row() {
        if (this.currentUser?.role === 'student') {
          if (course.isEnrolled) {
            Button('ç»§ç»­å­¦ä¹ ')
              .fontSize(11)
              .height(28)
              .width(70)
              .backgroundColor('#007AFF')
              .borderRadius(14)
              .fontColor(Color.White)
              .margin({ right: 10 })
              .onClick(() => {
                this.enterCourse(course);
              })
          } else {
            Button('åŠ å…¥è¯¾ç¨‹')
              .fontSize(11)
              .height(28)
              .width(70)
              .backgroundColor('#28a745')
              .borderRadius(14)
              .fontColor(Color.White)
              .margin({ right: 10 })
              .onClick(() => {
                this.enrollCourse(course);
              })
          }
        } else {
          Button('ç®¡ç†')
            .fontSize(11)
            .height(28)
            .width(70)
            .backgroundColor('#007AFF')
            .borderRadius(14)
            .fontColor(Color.White)
            .onClick(() => {
              this.manageCourse(course);
            })
        }
      }
      .margin({ top: 8 })
    }
    .padding(15)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 15 })
    .onClick(() => {
      this.viewCourseDetail(course);
    })
  }

  /**
   * ç­›é€‰è¯¾ç¨‹
   */
  filterCourses(): void {
    this.isLoading = true;
    setTimeout(() => {
      let filteredCourses = this.allCourses;
      // æŒ‰å­¦é™¢ç­›é€‰
      if (this.selectedDepartment !== 'all') {
        filteredCourses = filteredCourses.filter(course => course.department === this.selectedDepartment);
      }
      // æŒ‰ç±»åˆ«ç­›é€‰
      if (this.selectedCategory !== 'all') {
        filteredCourses = filteredCourses.filter(course => course.category === this.selectedCategory);
      }
      // æŒ‰æœç´¢æ–‡æœ¬ç­›é€‰
      if (this.searchText.trim()) {
        const searchLower = this.searchText.toLowerCase();
        filteredCourses = filteredCourses.filter(course => 
          course.name.toLowerCase().includes(searchLower) ||
          course.description.toLowerCase().includes(searchLower) ||
          course.teacherName.toLowerCase().includes(searchLower)
        );
      }
      // ä¿è¯å…¨éƒ¨æ¡ä»¶ä¸‹ï¼Œå­—æ®µä¸ºç©ºçš„è¯¾ç¨‹ä¹Ÿèƒ½æ˜¾ç¤º
      if (this.selectedDepartment === 'all' && this.selectedCategory === 'all' && !this.searchText.trim()) {
        filteredCourses = this.allCourses;
      }
      this.courses = filteredCourses;
      this.isLoading = false;
    }, 300);
  }

  viewCourseDetail(course: Course) {
    // TODO: è·³è½¬åˆ°è¯¾ç¨‹è¯¦æƒ…é¡µé¢
  }

  enterCourse(course: Course) {
    // TODO: è¿›å…¥è¯¾ç¨‹å­¦ä¹ é¡µé¢
  }

  enrollCourse(course: Course) {
    if (!this.currentUser) return;
    
    // è°ƒç”¨é€‰è¯¾å‡½æ•°
    const success = enrollCourse(this.currentUser.id, course.id);
    
    if (success) {
      // æ›´æ–°è¯¾ç¨‹çŠ¶æ€
      course.isEnrolled = true;
      course.enrolledCount++;
      
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      // è¿™é‡Œå¯ä»¥æ·»åŠ Toastæç¤º
      
      // é‡æ–°åŠ è½½è¯¾ç¨‹åˆ—è¡¨
      this.loadCourses();
    } else {
      // æ˜¾ç¤ºå¤±è´¥æç¤º
      // è¿™é‡Œå¯ä»¥æ·»åŠ Toastæç¤º
    }
  }

  /**
   * è·³è½¬åˆ°è¯¾ç¨‹ç¼–è¾‘é¡µé¢
   */
  manageCourse(course: Course) {
    router.pushUrl({ url: 'pages/EditCoursePage', params: { courseId: course.id } });
  }
} 