import router from '@ohos.router';
import { getCurrentUser } from '../common/UserStore';
import { UserInfo } from '../common/UserTypes';
import { getCourseProgress, getLearningProgress, LearningProgress } from '../common/LearningStore';
import { getEnrolledCourses } from '../common/CourseStore';
import { Course } from '../common/CourseTypes';

// å­¦ä¹ è¿›åº¦é¡µé¢ï¼Œå±•ç¤ºç”¨æˆ·å„è¯¾ç¨‹çš„å­¦ä¹ è¿›åº¦ä¸Žç»Ÿè®¡ä¿¡æ¯

/**
 * å­¦ä¹ è¿›åº¦é¡µé¢ç»„ä»¶
 * å±•ç¤ºå½“å‰ç”¨æˆ·åœ¨å„è¯¾ç¨‹çš„å­¦ä¹ è¿›åº¦ã€æµ‹éªŒæˆç»©ç­‰
 */
@Entry
@Component
struct LearningProgressPage {
  @State currentUser: UserInfo | null = getCurrentUser();
  @State courses: Course[] = [];
  @State isLoading: boolean = false;
  @State selectedTimeRange: string = 'week'; // week, month, semester

  aboutToAppear() {
    if (!this.currentUser) {
      router.replaceUrl({ url: 'pages/LoginPage' });
      return;
    }
    this.loadData();
  }

  loadData(): void {
    this.isLoading = true;
    
    setTimeout(() => {
      if (this.currentUser) {
        this.courses = getEnrolledCourses(this.currentUser.id);
      }
      this.isLoading = false;
    }, 500);
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button('â† è¿”å›ž')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            router.back();
          })
        
        Text('å­¦ä¹ è¿›åº¦')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .flexGrow(1)
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 20, bottom: 20 })
      .backgroundColor(Color.White)
      .border({ width: { bottom: 1 }, color: '#e0e0e0' })

      // å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          // æ€»ä½“ç»Ÿè®¡
          this.buildOverallStats()
          
          // æ—¶é—´èŒƒå›´é€‰æ‹©
          this.buildTimeRangeSelector()
          
          // è¯¾ç¨‹è¿›åº¦åˆ—è¡¨
          this.buildCourseProgressList()
        }
        .padding({ left: 20, right: 20, bottom: 100 })
      }
      .flexGrow(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder
  buildOverallStats() {
    Column() {
      Text('å­¦ä¹ ç»Ÿè®¡')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 15 })
      
      Row() {
        // æ€»è¯¾ç¨‹æ•°
        Column() {
          Text(this.courses.length.toString())
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#007AFF')
          
          Text('æ€»è¯¾ç¨‹æ•°')
            .fontSize(12)
            .fontColor('#666')
            .margin({ top: 5 })
        }
        .flexGrow(1)
        .alignItems(HorizontalAlign.Center)
        
        // å¹³å‡è¿›åº¦
        Column() {
          Text(this.getAverageProgress() + '%')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#28a745')
          
          Text('å¹³å‡è¿›åº¦')
            .fontSize(12)
            .fontColor('#666')
            .margin({ top: 5 })
        }
        .flexGrow(1)
        .alignItems(HorizontalAlign.Center)
        
        // å­¦ä¹ æ—¶é•¿
        Column() {
          Text(this.getTotalStudyTime() + 'h')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF9500')
          
          Text('å­¦ä¹ æ—¶é•¿')
            .fontSize(12)
            .fontColor('#666')
            .margin({ top: 5 })
        }
        .flexGrow(1)
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .margin({ bottom: 20 })
    }
  }

  @Builder
  buildTimeRangeSelector() {
    Row() {
      Text('æ—¶é—´èŒƒå›´')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 10 })
      
      Row() {
        ForEach(['week', 'month', 'semester'], (range: string) => {
          Button(this.getTimeRangeText(range))
            .fontSize(14)
            .height(32)
            .backgroundColor(this.selectedTimeRange === range ? '#007AFF' : '#f0f0f0')
            .fontColor(this.selectedTimeRange === range ? Color.White : '#333')
            .borderRadius(16)
            .margin({ right: 10 })
            .onClick(() => {
              this.selectedTimeRange = range;
              this.loadData();
            })
        })
      }
      .flexGrow(1)
      .justifyContent(FlexAlign.End)
    }
    .width('100%')
    .margin({ bottom: 20 })
  }

  @Builder
  buildCourseProgressList() {
    Column() {
      Text('è¯¾ç¨‹è¿›åº¦')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 15 })
      
      if (this.courses.length === 0) {
        Column() {
          Text('ðŸ“š')
            .fontSize(60)
            .margin({ top: 50, bottom: 20 })
          
          Text('æš‚æ— è¯¾ç¨‹')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .margin({ bottom: 10 })
          
          Text('æ‚¨è¿˜æ²¡æœ‰é€‰æ‹©ä»»ä½•è¯¾ç¨‹')
            .fontSize(14)
            .fontColor('#666')
        }
        .width('100%')
        .alignItems(HorizontalAlign.Center)
      } else {
        ForEach(this.courses, (course: Course) => {
          this.buildCourseProgressItem(course)
        })
      }
    }
  }

  @Builder
  buildCourseProgressItem(course: Course) {
    Column() {
      Row() {
        // è¯¾ç¨‹å°é¢
        Image(course.coverImage || $r('app.media.foreground'))
          .width(60)
          .height(45)
          .borderRadius(8)
          .backgroundColor('#f0f0f0')
        
        // è¯¾ç¨‹ä¿¡æ¯
        Column() {
          Text(course.name)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .margin({ bottom: 5 })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
          
          Text(course.teacherName)
            .fontSize(14)
            .fontColor('#666')
            .margin({ bottom: 5 })
          
          Row() {
            Text('è¿›åº¦')
              .fontSize(12)
              .fontColor('#999')
            
            Text(`${getCourseProgress(this.currentUser!.id, course.id)}%`)
              .fontSize(12)
              .fontColor('#007AFF')
              .fontWeight(FontWeight.Medium)
              .margin({ left: 5 })
          }
        }
        .alignItems(HorizontalAlign.Start)
        .flexGrow(1)
        .margin({ left: 15 })
        
        // è¿›åº¦æ¡
        Column() {
          Progress({ value: getCourseProgress(this.currentUser!.id, course.id), total: 100 })
            .width(100)
            .height(6)
            .backgroundColor('#f0f0f0')
            .color('#007AFF')
            .borderRadius(3)
          
          Text(this.getProgressStatus(getCourseProgress(this.currentUser!.id, course.id)))
            .fontSize(12)
            .fontColor(this.getProgressColor(getCourseProgress(this.currentUser!.id, course.id)))
            .margin({ top: 5 })
        }
        .alignItems(HorizontalAlign.End)
      }
      
      // æœ€è¿‘å­¦ä¹ è®°å½•
      if (getCourseProgress(this.currentUser!.id, course.id) > 0) {
        Row() {
          Text('æœ€è¿‘å­¦ä¹ ï¼š')
            .fontSize(12)
            .fontColor('#999')
          
          Text(this.getLastStudyTime(course.id))
            .fontSize(12)
            .fontColor('#666')
        }
        .width('100%')
        .margin({ top: 10 })
        .justifyContent(FlexAlign.Start)
      }
    }
    .width('100%')
    .padding(15)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 15 })
  }

  getAverageProgress(): number {
    if (this.courses.length === 0) return 0;
    
    const totalProgress = this.courses.reduce((sum, course) => {
      return sum + getCourseProgress(this.currentUser!.id, course.id);
    }, 0);
    
    return Math.round(totalProgress / this.courses.length);
  }

  getTotalStudyTime(): number {
    // æ¨¡æ‹Ÿè®¡ç®—æ€»å­¦ä¹ æ—¶é•¿
    return Math.round(this.courses.length * 2.5);
  }

  getTimeRangeText(range: string): string {
    switch (range) {
      case 'week':
        return 'æœ¬å‘¨';
      case 'month':
        return 'æœ¬æœˆ';
      case 'semester':
        return 'æœ¬å­¦æœŸ';
      default:
        return 'æœ¬å‘¨';
    }
  }

  getProgressStatus(progress: number): string {
    if (progress === 0) return 'æœªå¼€å§‹';
    if (progress < 30) return 'åˆšå¼€å§‹';
    if (progress < 70) return 'è¿›è¡Œä¸­';
    if (progress < 100) return 'å³å°†å®Œæˆ';
    return 'å·²å®Œæˆ';
  }

  getProgressColor(progress: number): string {
    if (progress === 0) return '#999';
    if (progress < 30) return '#FF9500';
    if (progress < 70) return '#007AFF';
    if (progress < 100) return '#28a745';
    return '#28a745';
  }

  getLastStudyTime(courseId: string): string {
    // æ¨¡æ‹ŸèŽ·å–æœ€è¿‘å­¦ä¹ æ—¶é—´
    const days = Math.floor(Math.random() * 7) + 1;
    if (days === 1) return 'æ˜¨å¤©';
    if (days === 2) return 'å‰å¤©';
    return `${days}å¤©å‰`;
  }
} 