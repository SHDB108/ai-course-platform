import router from '@ohos.router';
import { getCurrentUser, UserInfo } from '../common/UserStore';
import { getQuizzesByCourse, getStudentSubmissions, Quiz, QuizSubmission } from '../common/QuizStore';
import { getEnrolledCourses } from '../common/CourseStore';

@Entry
@Component
struct QuizListPage {
  @State currentUser: UserInfo | null = getCurrentUser();
  @State quizzes: Quiz[] = [];
  @State submissions: QuizSubmission[] = [];
  @State selectedType: string = 'all';
  @State isLoading: boolean = false;

  aboutToAppear() {
    if (!this.currentUser) {
      router.replaceUrl({ url: 'pages/LoginPage' });
      return;
    }
    this.loadQuizzes();
  }

  loadQuizzes() {
    this.isLoading = true;
    
    // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    setTimeout(() => {
      if (this.currentUser) {
        // è¿™é‡Œåº”è¯¥æ ¹æ®ç”¨æˆ·è§’è‰²å’Œè¯¾ç¨‹åŠ è½½æµ‹éªŒ
        // æš‚æ—¶åŠ è½½æ‰€æœ‰æµ‹éªŒä½œä¸ºç¤ºä¾‹
        this.quizzes = [
          {
            id: '1',
            courseId: '1',
            title: 'äººå·¥æ™ºèƒ½åŸºç¡€çŸ¥è¯†æµ‹éªŒ',
            description: 'æµ‹è¯•å¯¹äººå·¥æ™ºèƒ½åŸºæœ¬æ¦‚å¿µçš„ç†è§£',
            type: 'quiz',
            totalScore: 100,
            timeLimit: 60,
            startTime: '2024-01-15 09:00:00',
            endTime: '2024-01-15 10:00:00',
            status: 'published',
            isAutoGrade: true,
            createTime: '2024-01-10 00:00:00',
            updateTime: '2024-01-10 00:00:00'
          },
          {
            id: '2',
            courseId: '1',
            title: 'AIåº”ç”¨æ¡ˆä¾‹åˆ†æä½œä¸š',
            description: 'åˆ†æä¸€ä¸ªå®é™…çš„äººå·¥æ™ºèƒ½åº”ç”¨æ¡ˆä¾‹',
            type: 'assignment',
            totalScore: 50,
            startTime: '2024-01-20 00:00:00',
            endTime: '2024-01-27 23:59:59',
            status: 'published',
            isAutoGrade: false,
            createTime: '2024-01-18 00:00:00',
            updateTime: '2024-01-18 00:00:00'
          }
        ];
        
        if (this.currentUser.role === 'student') {
          this.submissions = getStudentSubmissions(this.currentUser.id);
        }
      }
      this.isLoading = false;
    }, 500);
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button('â† è¿”å›')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            router.back();
          })
        
        Text('æµ‹éªŒä½œä¸š')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .flexGrow(1)
          .textAlign(TextAlign.Center)
        
        Button('+ æ–°å»º')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            // TODO: è·³è½¬åˆ°æ–°å»ºæµ‹éªŒé¡µé¢
          })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 20, bottom: 20 })
      .backgroundColor(Color.White)
      .border({ width: { bottom: 1 }, color: '#e0e0e0' })

      // ç­›é€‰æ ‡ç­¾
      this.buildFilterTabs()
      
      // æµ‹éªŒåˆ—è¡¨
      this.buildQuizList()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder
  buildFilterTabs() {
    Row() {
      this.buildFilterTab('å…¨éƒ¨', 'all')
      this.buildFilterTab('æµ‹éªŒ', 'quiz')
      this.buildFilterTab('ä½œä¸š', 'assignment')
      this.buildFilterTab('å·²å®Œæˆ', 'completed')
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 15, bottom: 15 })
    .backgroundColor(Color.White)
  }

  @Builder
  buildFilterTab(label: string, value: string) {
    Button(label)
      .fontSize(14)
      .height(32)
      .backgroundColor(this.selectedType === value ? '#007AFF' : '#f0f0f0')
      .fontColor(this.selectedType === value ? Color.White : '#333')
      .borderRadius(16)
      .margin({ right: 10 })
      .onClick(() => {
        this.selectedType = value;
        this.filterQuizzes();
      })
  }

  @Builder
  buildQuizList() {
    if (this.isLoading) {
      Column() {
        LoadingProgress()
          .width(50)
          .height(50)
          .margin({ top: 100 })
        
        Text('åŠ è½½ä¸­...')
          .fontSize(14)
          .fontColor('#666')
          .margin({ top: 10 })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
    } else if (this.quizzes.length === 0) {
      Column() {
        Text('ğŸ“')
          .fontSize(60)
          .margin({ top: 100, bottom: 20 })
        
        Text('æš‚æ— æµ‹éªŒ')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .margin({ bottom: 10 })
        
        Text('æ‚¨è¿˜æ²¡æœ‰ä»»ä½•æµ‹éªŒæˆ–ä½œä¸š')
          .fontSize(14)
          .fontColor('#666')
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
    } else {
      List() {
        ForEach(this.quizzes, (quiz: Quiz) => {
          ListItem() {
            this.buildQuizItem(quiz)
          }
        })
      }
      .width('100%')
      .height('100%')
      .padding({ left: 20, right: 20 })
    }
  }

  @Builder
  buildQuizItem(quiz: Quiz) {
    Column() {
      Row() {
        // æµ‹éªŒå›¾æ ‡å’Œç±»å‹
        Column() {
          Text(quiz.type === 'quiz' ? 'ğŸ“' : 'ğŸ“‹')
            .fontSize(24)
          
          Text(quiz.type === 'quiz' ? 'æµ‹éªŒ' : 'ä½œä¸š')
            .fontSize(12)
            .fontColor('#666')
        }
        .alignItems(HorizontalAlign.Center)
        .margin({ right: 15 })
        
        // æµ‹éªŒä¿¡æ¯
        Column() {
          Text(quiz.title)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .margin({ bottom: 5 })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
          
          Text(quiz.description)
            .fontSize(14)
            .fontColor('#666')
            .margin({ bottom: 5 })
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
          
          Row() {
            Text(`æ€»åˆ†ï¼š${quiz.totalScore}åˆ†`)
              .fontSize(12)
              .fontColor('#999')
            
            if (quiz.timeLimit) {
              Text('â€¢')
                .fontSize(12)
                .fontColor('#999')
                .margin({ left: 8, right: 8 })
              
              Text(`é™æ—¶ï¼š${quiz.timeLimit}åˆ†é’Ÿ`)
                .fontSize(12)
                .fontColor('#999')
            }
            
            Text('â€¢')
              .fontSize(12)
              .fontColor('#999')
              .margin({ left: 8, right: 8 })
            
            Text(this.formatTime(quiz.endTime))
              .fontSize(12)
              .fontColor(this.isQuizExpired(quiz.endTime) ? '#FF3B30' : '#999')
          }
        }
        .alignItems(HorizontalAlign.Start)
        .flexGrow(1)
        
        // çŠ¶æ€å’Œæ“ä½œ
        Column() {
          // çŠ¶æ€æ ‡ç­¾
          if (this.getSubmissionByQuizId(quiz.id)) {
            Text('å·²å®Œæˆ')
              .fontSize(12)
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .backgroundColor('#28a745')
              .fontColor(Color.White)
              .borderRadius(10)
              .margin({ bottom: 8 })
            
            Text(`å¾—åˆ†ï¼š${this.getSubmissionByQuizId(quiz.id)?.totalScore || 0}`)
              .fontSize(12)
              .fontColor('#28a745')
          } else if (this.isQuizExpired(quiz.endTime)) {
            Text('å·²è¿‡æœŸ')
              .fontSize(12)
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .backgroundColor('#FF3B30')
              .fontColor(Color.White)
              .borderRadius(10)
              .margin({ bottom: 8 })
          } else {
            Text('è¿›è¡Œä¸­')
              .fontSize(12)
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .backgroundColor('#007AFF')
              .fontColor(Color.White)
              .borderRadius(10)
              .margin({ bottom: 8 })
          }
          
          // æ“ä½œæŒ‰é’®
          if (this.currentUser?.role === 'student') {
            if (this.getSubmissionByQuizId(quiz.id)) {
              Button('æŸ¥çœ‹ç»“æœ')
                .fontSize(12)
                .height(30)
                .backgroundColor('#007AFF')
                .borderRadius(15)
                .fontColor(Color.White)
                .onClick(() => {
                  this.viewResult(quiz, this.getSubmissionByQuizId(quiz.id));
                })
            } else if (!this.isQuizExpired(quiz.endTime)) {
              Button('å¼€å§‹ç­”é¢˜')
                .fontSize(12)
                .height(30)
                .backgroundColor('#28a745')
                .borderRadius(15)
                .fontColor(Color.White)
                .onClick(() => {
                  this.startQuiz(quiz);
                })
            } else {
              Button('æŸ¥çœ‹è¯¦æƒ…')
                .fontSize(12)
                .height(30)
                .backgroundColor('#999')
                .borderRadius(15)
                .fontColor(Color.White)
                .onClick(() => {
                  this.viewQuizDetail(quiz);
                })
            }
          } else {
            Button('ç®¡ç†')
              .fontSize(12)
              .height(30)
              .backgroundColor('#007AFF')
              .borderRadius(15)
              .fontColor(Color.White)
              .onClick(() => {
                this.manageQuiz(quiz);
              })
          }
        }
        .alignItems(HorizontalAlign.End)
      }
    }
    .width('100%')
    .padding(15)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 15 })
    .onClick(() => {
      this.viewQuizDetail(quiz);
    })
  }

  getSubmissionByQuizId(quizId: string): QuizSubmission | undefined {
    return this.submissions.find(s => s.quizId === quizId);
  }

  filterQuizzes() {
    // TODO: å®ç°æµ‹éªŒç­›é€‰é€»è¾‘
  }

  viewQuizDetail(quiz: Quiz) {
    // TODO: è·³è½¬åˆ°æµ‹éªŒè¯¦æƒ…é¡µé¢
  }

  startQuiz(quiz: Quiz) {
    // TODO: è·³è½¬åˆ°ç­”é¢˜é¡µé¢
  }

  viewResult(quiz: Quiz, submission: QuizSubmission | undefined) {
    // TODO: è·³è½¬åˆ°ç»“æœæŸ¥çœ‹é¡µé¢
  }

  manageQuiz(quiz: Quiz) {
    // TODO: è·³è½¬åˆ°æµ‹éªŒç®¡ç†é¡µé¢
  }

  isQuizExpired(endTime: string): boolean {
    return new Date() > new Date(endTime);
  }

  formatTime(timeStr: string): string {
    const date = new Date(timeStr);
    const now = new Date();
    const diff = date.getTime() - now.getTime();
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    
    if (diff < 0) {
      return 'å·²ç»“æŸ';
    } else if (days > 0) {
      return `å‰©ä½™${days}å¤©`;
    } else if (hours > 0) {
      return `å‰©ä½™${hours}å°æ—¶`;
    } else {
      return 'å³å°†ç»“æŸ';
    }
  }
} 