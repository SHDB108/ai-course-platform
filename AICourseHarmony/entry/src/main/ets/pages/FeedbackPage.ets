import router from '@ohos.router';
import { getCurrentUser } from '../common/UserStore';
import { UserInfo } from '../common/UserTypes';

// å£°æ˜FormFieldæ¥å£
interface FormField {
  label: string;
  placeholder: string;
  value: string;
  onChange: (value: string) => void;
  type?: 'text' | 'select' | 'multiline';
  options?: string[];
  multiline?: boolean;
}

interface Feedback {
  id: string;
  type: 'bug' | 'feature' | 'suggestion' | 'complaint';
  title: string;
  content: string;
  contact: string;
  priority: 'low' | 'medium' | 'high';
  status: 'pending' | 'processing' | 'resolved' | 'closed';
  createTime: string;
  userId: string;
  userName: string;
}

// åé¦ˆé¡µé¢ï¼Œæ”¯æŒç”¨æˆ·æäº¤æ„è§å’Œå»ºè®®

/**
 * åé¦ˆé¡µé¢ç»„ä»¶
 * æä¾›ç”¨æˆ·åé¦ˆè¡¨å•ä¸æäº¤é€»è¾‘
 */
@Entry
@Component
struct FeedbackPage {
  @State currentUser: UserInfo | null = getCurrentUser();
  @State feedbackType: string = 'suggestion';
  @State title: string = '';
  @State content: string = '';
  @State contact: string = '';
  @State priority: string = 'medium';
  @State isSubmitting: boolean = false;

  aboutToAppear() {
    if (!this.currentUser) {
      router.replaceUrl({ url: 'pages/LoginPage' });
      return;
    }
  }

  build() {
    Column() {
      this.buildHeader()
      this.buildForm()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder
  buildHeader() {
    Row() {
      Button('\u2190')
        .fontSize(20)
        .backgroundColor(Color.Transparent)
        .fontColor('#007AFF')
        .onClick(() => {
          router.back();
        })
      Text('\u610f\u89c1\u53cd\u9988')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .flexGrow(1)
        .textAlign(TextAlign.Center)
      Button('\u63d0\u4ea4')
        .fontSize(16)
        .backgroundColor(Color.Transparent)
        .fontColor(this.isSubmitting ? '#999' : '#007AFF')
        .onClick(() => {
          if (!this.isSubmitting) {
            this.submitFeedback();
          }
        })
    }
    .width('100%')
    .height(60)
    .backgroundColor(Color.White)
    .padding({ left: 20, right: 20 })
    .border({ width: { bottom: 1 }, color: '#e0e0e0' })
  }

  @Builder
  buildForm() {
    Scroll() {
      Column() {
        // åé¦ˆç±»å‹
        this.buildFormSection('åé¦ˆç±»å‹', [
          {
            label: 'åé¦ˆç±»å‹',
            placeholder: 'è¯·é€‰æ‹©åé¦ˆç±»å‹',
            value: this.feedbackType,
            onChange: (value: string) => {
              this.feedbackType = value;
            },
            type: 'select',
            options: ['bug', 'feature', 'suggestion', 'complaint']
          } as FormField
        ] as FormField[])

        // åŸºæœ¬ä¿¡æ¯
        this.buildFormSection('åŸºæœ¬ä¿¡æ¯', [
          {
            label: 'æ ‡é¢˜',
            placeholder: 'è¯·ç®€è¦æè¿°æ‚¨çš„åé¦ˆï¼ˆå¿…å¡«ï¼‰',
            value: this.title,
            onChange: (value: string) => {
              this.title = value;
            }
          } as FormField,
          {
            label: 'è¯¦ç»†æè¿°',
            placeholder: 'è¯·è¯¦ç»†æè¿°æ‚¨çš„é—®é¢˜æˆ–å»ºè®®ï¼ˆå¿…å¡«ï¼‰',
            value: this.content,
            onChange: (value: string) => {
              this.content = value;
            },
            multiline: true
          } as FormField
        ] as FormField[])

        // ä¼˜å…ˆçº§å’Œè”ç³»æ–¹å¼
        this.buildFormSection('å…¶ä»–ä¿¡æ¯', [
          {
            label: 'ä¼˜å…ˆçº§',
            placeholder: 'è¯·é€‰æ‹©ä¼˜å…ˆçº§',
            value: this.priority,
            onChange: (value: string) => {
              this.priority = value;
            },
            type: 'select',
            options: ['low', 'medium', 'high']
          } as FormField,
          {
            label: 'è”ç³»æ–¹å¼',
            placeholder: 'è¯·ç•™ä¸‹æ‚¨çš„é‚®ç®±æˆ–æ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰',
            value: this.contact,
            onChange: (value: string) => {
              this.contact = value;
            }
          } as FormField
        ] as FormField[])

        // åé¦ˆè¯´æ˜
        this.buildInfoSection()
      }
      .padding(20)
    }
    .flexGrow(1)
  }

  @Builder
  buildFormSection(title: string, fields: FormField[]) {
    Column() {
      Text(title)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 15 })
      
      ForEach(fields, (field: FormField) => {
        this.buildFormField(field)
      })
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 20 })
  }

  @Builder
  buildFormField(field: FormField) {
    Column() {
      Text(field.label)
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 8 })
      if (field.type === 'select') {
        Select((field.options || []).map(option => ({ value: option } as SelectOption)))
          .selected((field.options || []).indexOf(field.value))
          .onSelect((index: number, value: string) => {
            field.onChange(value);
          })
          .width('100%')
          .height(40)
          .backgroundColor('#f8f9fa')
          .borderRadius(8)
      } else if (field.multiline) {
        TextArea({ placeholder: field.placeholder, text: field.value })
          .onChange((value: string) => {
            field.onChange(value);
          })
          .width('100%')
          .height(120)
          .backgroundColor('#f8f9fa')
          .borderRadius(8)
          .padding(12)
      } else {
        TextInput({ 
          placeholder: field.placeholder, 
          text: field.value
        })
          .onChange((value: string) => {
            field.onChange(value);
          })
          .width('100%')
          .height(40)
          .backgroundColor('#f8f9fa')
          .borderRadius(8)
          .padding({ left: 12, right: 12 })
      }
    }
    .width('100%')
    .margin({ bottom: 16 })
  }

  @Builder
  buildInfoSection() {
    Column() {
      Text('åé¦ˆè¯´æ˜')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 15 })
      
      Column() {
        this.buildInfoItem('ğŸ“ é—®é¢˜åé¦ˆ', 'å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·è¯¦ç»†æè¿°é—®é¢˜ç°è±¡å’Œå¤ç°æ­¥éª¤ã€‚')
        this.buildInfoItem('ğŸ’¡ åŠŸèƒ½å»ºè®®', 'å¦‚æœæ‚¨å¸Œæœ›å¹³å°å¢åŠ æ–°åŠŸèƒ½ï¼Œè¯·è¯´æ˜åŠŸèƒ½ç”¨é€”å’Œä½¿ç”¨åœºæ™¯ã€‚')
        this.buildInfoItem('ğŸ”§ æ”¹è¿›å»ºè®®', 'å¦‚æœæ‚¨å¯¹ç°æœ‰åŠŸèƒ½æœ‰æ”¹è¿›å»ºè®®ï¼Œè¯·è¯´æ˜æ”¹è¿›æ–¹å‘å’Œé¢„æœŸæ•ˆæœã€‚')
        this.buildInfoItem('âš ï¸ æŠ•è¯‰ä¸¾æŠ¥', 'å¦‚æœæ‚¨å‘ç°è¿è§„å†…å®¹æˆ–è¡Œä¸ºï¼Œè¯·æä¾›ç›¸å…³è¯æ®å’Œè¯¦ç»†è¯´æ˜ã€‚')
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#f8f9fa')
      .borderRadius(8)
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 20 })
  }

  @Builder
  buildInfoItem(title: string, description: string) {
    Row() {
      Text(title)
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333')
        .flexGrow(1)
      
      Text(description)
        .fontSize(12)
        .fontColor('#666')
        .flexGrow(2)
        .lineHeight(16)
    }
    .width('100%')
    .margin({ bottom: 12 })
    .alignItems(VerticalAlign.Top)
  }

  submitFeedback() {
    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!this.title.trim()) {
      this.showError('è¯·è¾“å…¥åé¦ˆæ ‡é¢˜');
      return;
    }
    if (!this.content.trim()) {
      this.showError('è¯·è¾“å…¥è¯¦ç»†æè¿°');
      return;
    }

    this.isSubmitting = true;

    // æ¨¡æ‹Ÿæäº¤
    setTimeout(() => {
      const feedback: Feedback = {
        id: Date.now().toString(),
        type: this.feedbackType as 'bug' | 'feature' | 'suggestion' | 'complaint',
        title: this.title,
        content: this.content,
        contact: this.contact,
        priority: this.priority as 'low' | 'medium' | 'high',
        status: 'pending',
        createTime: new Date().toISOString(),
        userId: this.currentUser?.id || '',
        userName: this.currentUser?.realName || ''
      };

      // TODO: å®é™…æäº¤åˆ°æœåŠ¡å™¨
      console.log('æäº¤åé¦ˆ:', feedback);

      this.showSuccess('åé¦ˆæäº¤æˆåŠŸï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†æ‚¨çš„åé¦ˆï¼');
      
      // é‡ç½®è¡¨å•
      this.title = '';
      this.content = '';
      this.contact = '';
      this.feedbackType = 'suggestion';
      this.priority = 'medium';
      
      this.isSubmitting = false;

      // è¿”å›ä¸Šä¸€é¡µ
      setTimeout(() => {
        router.back();
      }, 2000);
    }, 1000);
  }

  showError(message: string) {
    console.error(message);
    // TODO: æ˜¾ç¤ºé”™è¯¯æç¤º
  }

  showSuccess(message: string) {
    console.log(message);
    // TODO: æ˜¾ç¤ºæˆåŠŸæç¤º
  }
} 