import router from '@ohos.router';
import { getCurrentUser, users, UserInfo, UserRole } from '../common/UserStore';

interface UserIdParams {
  userId: string;
}

@Entry
@Component
struct UserManagePage {
  @State currentUser: UserInfo | null = getCurrentUser();
  @State userList: UserInfo[] = [];
  @State searchText: string = '';
  @State selectedRole: string = 'all';
  @State isLoading: boolean = false;

  aboutToAppear() {
    if (!this.currentUser || this.currentUser.role !== 'admin') {
      router.replaceUrl({ url: 'pages/LoginPage' });
      return;
    }
    this.loadUsers();
  }

  loadUsers() {
    this.isLoading = true;
    
    // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    setTimeout(() => {
      this.userList = users;
      this.isLoading = false;
    }, 500);
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button('â† è¿”å›')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            router.back();
          })
        
        Text('ç”¨æˆ·ç®¡ç†')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .flexGrow(1)
          .textAlign(TextAlign.Center)
        
        Button('+ æ·»åŠ ')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            router.pushUrl({ url: 'pages/EditUserPage' });
          })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 20, bottom: 20 })
      .backgroundColor(Color.White)
      .border({ width: { bottom: 1 }, color: '#e0e0e0' })

      // æœç´¢å’Œç­›é€‰
      this.buildSearchAndFilter()
      
      // ç”¨æˆ·åˆ—è¡¨
      this.buildUserList()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder
  buildSearchAndFilter() {
    Column() {
      // æœç´¢æ¡†
      Row() {
        TextInput({ 
          placeholder: 'æœç´¢ç”¨æˆ·åæˆ–çœŸå®å§“å', 
          text: this.searchText 
        })
          .onChange((value: string) => {
            this.searchText = value;
            this.filterUsers();
          })
          .width('85%')
          .height(40)
          .backgroundColor('#f8f9fa')
          .borderRadius(20)
          .padding({ left: 15, right: 15 })
          .placeholderColor('#999')
        Button('ğŸ”')
          .width('15%')
          .height(40)
          .backgroundColor('#007AFF')
          .borderRadius(20)
          .fontColor(Color.White)
          .onClick(() => {
            this.filterUsers();
          })
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
      .margin({ bottom: 15 })

      // è§’è‰²ç­›é€‰
      Scroll() {
        Row() {
          this.buildFilterChip('å…¨éƒ¨', 'all')
          this.buildFilterChip('å­¦ç”Ÿ', 'student')
          this.buildFilterChip('æ•™å¸ˆ', 'teacher')
          this.buildFilterChip('ç®¡ç†å‘˜', 'admin')
        }
        .padding({ left: 20, right: 20 })
      }
      .scrollable(ScrollDirection.Horizontal)
      .margin({ bottom: 15 })
    }
    .padding({ left: 20, right: 20, top: 15 })
    .backgroundColor(Color.White)
  }

  @Builder
  buildFilterChip(label: string, value: string) {
    Button(label)
      .fontSize(14)
      .height(32)
      .backgroundColor(this.selectedRole === value ? '#007AFF' : '#f0f0f0')
      .fontColor(this.selectedRole === value ? Color.White : '#333')
      .borderRadius(16)
      .margin({ right: 10 })
      .onClick(() => {
        this.selectedRole = value;
        this.filterUsers();
      })
  }

  @Builder
  buildUserList() {
    if (this.isLoading) {
      Column() {
        LoadingProgress()
          .width(50)
          .height(50)
          .margin({ top: 100 })
        
        Text('åŠ è½½ä¸­...')
          .fontSize(14)
          .fontColor('#666')
          .margin({ top: 10 })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
    } else if (this.userList.length === 0) {
      Column() {
        Text('ğŸ‘¥')
          .fontSize(60)
          .margin({ top: 100, bottom: 20 })
        
        Text('æš‚æ— ç”¨æˆ·')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .margin({ bottom: 10 })
        
        Text('ç³»ç»Ÿä¸­è¿˜æ²¡æœ‰ä»»ä½•ç”¨æˆ·')
          .fontSize(14)
          .fontColor('#666')
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
    } else {
      List() {
        ForEach(this.userList, (user: UserInfo) => {
          ListItem() {
            this.buildUserItem(user)
          }
        })
      }
      .width('100%')
      .height('100%')
      .padding({ left: 20, right: 20 })
    }
  }

  @Builder
  buildUserItem(user: UserInfo) {
    Column() {
      Row() {
        // ç”¨æˆ·å¤´åƒ
        Image(user.avatar || $r('app.media.foreground'))
          .width(50)
          .height(50)
          .borderRadius(25)
          .backgroundColor('#f0f0f0')
        // ç”¨æˆ·ä¿¡æ¯
        Column() {
          Text(user.realName)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .margin({ bottom: 5 })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
          Text(`@${user.username}`)
            .fontSize(14)
            .fontColor('#666')
            .margin({ bottom: 5 })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
          Row() {
            Text(this.getRoleText(user.role))
              .fontSize(12)
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .backgroundColor(this.getRoleColor(user.role))
              .fontColor(Color.White)
              .borderRadius(10)
            Text('â€¢')
              .fontSize(12)
              .fontColor('#999')
              .margin({ left: 8, right: 8 })
            Text(user.status === 'active' ? 'æ­£å¸¸' : 'ç¦ç”¨')
              .fontSize(12)
              .fontColor(user.status === 'active' ? '#28a745' : '#FF3B30')
          }
        }
        .alignItems(HorizontalAlign.Start)
        .flexGrow(1)
        .margin({ left: 15 })
      }
      .width('100%')
      // åº•éƒ¨æ“ä½œæŒ‰é’®ç»„æ¨ªå‘æ’åˆ—
      Row() {
        Button('ç¼–è¾‘')
          .fontSize(11)
          .height(28)
          .width(70)
          .backgroundColor('#007AFF')
          .borderRadius(14)
          .fontColor(Color.White)
          .margin({ right: 10 })
          .onClick(() => {
            this.editUser(user);
          })
        Button(user.status === 'active' ? 'ç¦ç”¨' : 'å¯ç”¨')
          .fontSize(11)
          .height(28)
          .width(70)
          .backgroundColor(user.status === 'active' ? '#FF3B30' : '#28a745')
          .borderRadius(14)
          .fontColor(Color.White)
          .onClick(() => {
            this.toggleUserStatus(user);
          })
      }
      .margin({ top: 8 })
    }
    .padding(15)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 15 })
    .onClick(() => {
      this.viewUserDetail(user);
    })
  }

  filterUsers() {
    this.isLoading = true;
    
    setTimeout(() => {
      let filteredUsers = users;
      
      // æŒ‰è§’è‰²ç­›é€‰
      if (this.selectedRole !== 'all') {
        filteredUsers = filteredUsers.filter(user => user.role === this.selectedRole);
      }
      
      // æŒ‰æœç´¢æ–‡æœ¬ç­›é€‰
      if (this.searchText.trim()) {
        const searchLower = this.searchText.toLowerCase();
        filteredUsers = filteredUsers.filter(user => 
          user.realName.toLowerCase().includes(searchLower) ||
          user.username.toLowerCase().includes(searchLower) ||
          user.email.toLowerCase().includes(searchLower)
        );
      }
      
      this.userList = filteredUsers;
      this.isLoading = false;
    }, 300);
  }

  viewUserDetail(user: UserInfo) {
    // TODO: è·³è½¬åˆ°ç”¨æˆ·è¯¦æƒ…é¡µé¢
  }

  editUser(user: UserInfo) {
    const userIdParams: UserIdParams = { userId: user.id };
    router.pushUrl({ 
      url: 'pages/EditUserPage',
      params: userIdParams
    });
  }

  toggleUserStatus(user: UserInfo) {
    const userIndex = users.findIndex(u => u.id === user.id);
    if (userIndex === -1) return;
    
    // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
    users[userIndex].status = user.status === 'active' ? 'inactive' : 'active';
    
    // æ›´æ–°å½“å‰ç”¨æˆ·åˆ—è¡¨
    this.loadUsers();
    
    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    const newStatus = users[userIndex].status === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨';
    // è¿™é‡Œå¯ä»¥æ·»åŠ Toastæç¤º
  }

  getRoleText(role: UserRole): string {
    switch (role) {
      case 'admin':
        return 'ç®¡ç†å‘˜';
      case 'teacher':
        return 'æ•™å¸ˆ';
      case 'student':
        return 'å­¦ç”Ÿ';
      default:
        return 'æœªçŸ¥';
    }
  }

  getRoleColor(role: UserRole): string {
    switch (role) {
      case 'admin':
        return '#FF3B30';
      case 'teacher':
        return '#007AFF';
      case 'student':
        return '#28a745';
      default:
        return '#999';
    }
  }
} 