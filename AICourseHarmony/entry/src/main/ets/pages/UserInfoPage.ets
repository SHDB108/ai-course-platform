import router from '@ohos.router';
import { getCurrentUser, updateUserInfo, UserInfo } from '../common/UserStore';

interface EditForm {
  realName: string;
  email: string;
  phone: string;
  major?: string;
  grade?: string;
  department?: string;
  title?: string;
}

@Entry
@Component
struct UserInfoPage {
  @State currentUser: UserInfo | null = getCurrentUser();
  @State editForm: EditForm = {
    realName: '',
    email: '',
    phone: '',
    major: '',
    grade: '',
    department: '',
    title: ''
  };
  @State isEditing: boolean = false;
  @State isLoading: boolean = false;
  @State message: string = '';

  aboutToAppear() {
    if (!this.currentUser) {
      router.replaceUrl({ url: 'pages/LoginPage' });
      return;
    }
    this.initEditForm();
  }

  initEditForm() {
    if (this.currentUser) {
      this.editForm = {
        realName: this.currentUser.realName,
        email: this.currentUser.email,
        phone: this.currentUser.phone,
        major: this.currentUser.major || '',
        grade: this.currentUser.grade || '',
        department: this.currentUser.department || '',
        title: this.currentUser.title || ''
      };
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button('â† è¿”å›')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            router.back();
          })
        
        Text('ä¸ªäººä¿¡æ¯')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .flexGrow(1)
          .textAlign(TextAlign.Center)
        
        Button(this.isEditing ? 'å–æ¶ˆ' : 'ç¼–è¾‘')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            if (this.isEditing) {
              this.cancelEdit();
            } else {
              this.startEdit();
            }
          })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 20, bottom: 20 })
      .backgroundColor(Color.White)
      .border({ width: { bottom: 1 }, color: '#e0e0e0' })

      // å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          // å¤´åƒåŒºåŸŸ
          this.buildAvatarSection()
          
          // åŸºæœ¬ä¿¡æ¯
          this.buildBasicInfo()
          
          // è§’è‰²ç‰¹æœ‰ä¿¡æ¯
          this.buildRoleSpecificInfo()
          
          // ä¿å­˜æŒ‰é’®
          if (this.isEditing) {
            this.buildSaveButton()
          }
        }
        .padding({ left: 20, right: 20, bottom: 100 })
      }
      .flexGrow(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder
  buildAvatarSection() {
    Column() {
      Stack() {
        Image(this.currentUser?.avatar || $r('app.media.foreground'))
          .width(80)
          .height(80)
          .borderRadius(40)
          .backgroundColor('#f0f0f0')
        
        if (this.isEditing) {
          Button('ğŸ“·')
            .width(30)
            .height(30)
            .borderRadius(15)
            .backgroundColor('#007AFF')
            .fontColor(Color.White)
            .position({ x: 50, y: 50 })
            .onClick(() => {
              // TODO: å®ç°å¤´åƒä¸Šä¼ 
            })
        }
      }
      
      Text(this.currentUser?.realName || '')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 15, bottom: 5 })
      
      Text(this.getRoleText(this.currentUser?.role))
        .fontSize(14)
        .fontColor('#666')
        .padding({ left: 10, right: 10, top: 5, bottom: 5 })
        .backgroundColor('#f0f0f0')
        .borderRadius(10)
    }
    .alignItems(HorizontalAlign.Center)
    .padding({ top: 30, bottom: 30 })
  }

  @Builder
  buildBasicInfo() {
    Column() {
      Text('åŸºæœ¬ä¿¡æ¯')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 15 })
      
      this.buildInfoItem('ç”¨æˆ·å', this.currentUser?.username || '', false)
      this.buildInfoItem('çœŸå®å§“å', this.editForm.realName, this.isEditing, 'realName')
      this.buildInfoItem('é‚®ç®±', this.editForm.email, this.isEditing, 'email')
      this.buildInfoItem('æ‰‹æœºå·', this.editForm.phone, this.isEditing, 'phone')
    }
    .margin({ bottom: 30 })
  }

  @Builder
  buildRoleSpecificInfo() {
    if (this.currentUser?.role === 'student') {
      Column() {
        Text('å­¦ç”Ÿä¿¡æ¯')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 15 })
        
        this.buildInfoItem('å­¦å·', this.currentUser.studentId ?? '', false)
        this.buildInfoItem('ä¸“ä¸š', this.editForm.major ?? '', this.isEditing, 'major')
        this.buildInfoItem('å¹´çº§', this.editForm.grade ?? '', this.isEditing, 'grade')
      }
      .margin({ bottom: 30 })
    } else if (this.currentUser?.role === 'teacher') {
      Column() {
        Text('æ•™å¸ˆä¿¡æ¯')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 15 })
        
        this.buildInfoItem('å·¥å·', this.currentUser.teacherId ?? '', false)
        this.buildInfoItem('é™¢ç³»', this.editForm.department ?? '', this.isEditing, 'department')
        this.buildInfoItem('èŒç§°', this.editForm.title ?? '', this.isEditing, 'title')
      }
      .margin({ bottom: 30 })
    }
  }

  @Builder
  buildInfoItem(label: string, value: string, editable: boolean, field?: string) {
    Row() {
      Text(label)
        .fontSize(14)
        .fontColor('#666')
        .width(80)
      
      if (editable) {
        TextInput({ text: value })
          .onChange((text: string) => {
            if (field) {
              switch (field) {
                case 'realName':
                  this.editForm.realName = text;
                  break;
                case 'email':
                  this.editForm.email = text;
                  break;
                case 'phone':
                  this.editForm.phone = text;
                  break;
                case 'major':
                  this.editForm.major = text;
                  break;
                case 'grade':
                  this.editForm.grade = text;
                  break;
                case 'department':
                  this.editForm.department = text;
                  break;
                case 'title':
                  this.editForm.title = text;
                  break;
              }
            }
          })
          .flexGrow(1)
          .height(40)
          .backgroundColor('#f8f9fa')
          .borderRadius(8)
          .padding({ left: 10, right: 10 })
      } else {
        Text(value)
          .fontSize(14)
          .flexGrow(1)
      }
    }
    .width('100%')
    .padding({ top: 15, bottom: 15 })
    .backgroundColor(Color.White)
    .borderRadius(8)
    .margin({ bottom: 10 })
    .padding({ left: 15, right: 15 })
  }

  @Builder
  buildSaveButton() {
    Button(this.isLoading ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜')
      .width('100%')
      .height(50)
      .backgroundColor(this.isLoading ? '#ccc' : '#007AFF')
      .borderRadius(8)
      .fontSize(16)
      .fontWeight(FontWeight.Medium)
      .fontColor(Color.White)
      .onClick(() => {
        this.saveUserInfo();
      })
      .enabled(!this.isLoading)
      .margin({ top: 20 })
  }

  startEdit() {
    this.isEditing = true;
  }

  cancelEdit() {
    this.isEditing = false;
    this.initEditForm();
  }

  saveUserInfo() {
    this.isLoading = true;
    
    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!this.editForm.realName.trim()) {
      this.message = 'è¯·è¾“å…¥çœŸå®å§“å';
      this.isLoading = false;
      return;
    }
    
    if (!this.editForm.email.trim()) {
      this.message = 'è¯·è¾“å…¥é‚®ç®±';
      this.isLoading = false;
      return;
    }
    
    if (!this.editForm.phone.trim()) {
      this.message = 'è¯·è¾“å…¥æ‰‹æœºå·';
      this.isLoading = false;
      return;
    }

    // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
    setTimeout(() => {
      const success = updateUserInfo(this.editForm);
      
      if (success) {
        this.message = 'ä¿å­˜æˆåŠŸ';
        this.isEditing = false;
        this.currentUser = getCurrentUser();
      } else {
        this.message = 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•';
      }
      
      this.isLoading = false;
    }, 1000);
  }

  getRoleText(role?: string): string {
    switch (role) {
      case 'admin':
        return 'ç³»ç»Ÿç®¡ç†å‘˜';
      case 'teacher':
        return 'æ•™å¸ˆ';
      case 'student':
        return 'å­¦ç”Ÿ';
      default:
        return 'æœªçŸ¥';
    }
  }
} 