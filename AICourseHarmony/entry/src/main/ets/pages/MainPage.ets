import router from '@ohos.router';
import { getCurrentUser, UserInfo, UserRole } from '../common/UserStore';
import { getEnrolledCourses, getAllCourses, getCoursesByTeacher, Course } from '../common/CourseStore';
import { getActiveRecommendations, LearningRecommendation } from '../common/LearningStore';
import { getStudentSubmissions, QuizSubmission } from '../common/QuizStore';

@Entry
@Component
struct MainPage {
  @State currentUser: UserInfo | null = getCurrentUser();
  @State courses: Course[] = [];
  @State recommendations: LearningRecommendation[] = [];
  @State submissions: QuizSubmission[] = [];
  @State recentSubmissions: QuizSubmission[] = [];
  @State currentTab: number = 0;

  aboutToAppear() {
    if (this.currentUser) {
      this.loadUserData();
      this.loadRecommendations();
      this.loadRecentSubmissions();
    }
  }

  loadUserData() {
    if (!this.currentUser) {
      router.replaceUrl({ url: 'pages/LoginPage' });
      return;
    }

    // æ ¹æ®ç”¨æˆ·è§’è‰²åŠ è½½ä¸åŒæ•°æ®
    if (this.currentUser.role === 'student') {
      this.courses = getEnrolledCourses(this.currentUser.id);
      this.recommendations = getActiveRecommendations(this.currentUser.id);
      this.submissions = getStudentSubmissions(this.currentUser.id);
    } else if (this.currentUser.role === 'teacher') {
      this.courses = getCoursesByTeacher(this.currentUser.id);
    } else if (this.currentUser.role === 'admin') {
      this.courses = getAllCourses();
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.buildHeader()
      
      // å†…å®¹åŒºåŸŸ
      if (this.currentTab === 0) {
        this.buildHomeTab()
      } else if (this.currentTab === 1) {
        this.buildCourseTab()
      } else if (this.currentTab === 2) {
        this.buildQuizTab()
      } else if (this.currentTab === 3) {
        this.buildProfileTab()
      }
      
      // åº•éƒ¨å¯¼èˆªæ 
      this.buildBottomNav()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder
  buildHeader() {
    Row() {
      Column() {
        Text('AIè¯¾ç¨‹å¹³å°')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
        
        if (this.currentUser) {
          Text(`æ¬¢è¿Žï¼Œ${this.currentUser.realName}`)
            .fontSize(14)
            .fontColor(Color.White)
            .opacity(0.8)
        }
      }
      .alignItems(HorizontalAlign.Start)
      .flexGrow(1)
      
      Button('è®¾ç½®')
        .fontSize(14)
        .backgroundColor(Color.Transparent)
        .fontColor(Color.White)
        .onClick(() => {
          router.pushUrl({ url: 'pages/SystemSettingPage' });
        })
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 50, bottom: 20 })
    .backgroundColor('#007AFF')
  }

  @Builder
  buildHomeTab() {
    Scroll() {
      Column() {
        // å¿«é€Ÿæ“ä½œå¡ç‰‡
        this.buildQuickActions()
        
        // AIå­¦ä¹ æŽ¨è
        this.buildRecommendations()
        
        // æœ€è¿‘æ´»åŠ¨
        this.buildRecentActivity()
      }
      .padding({ left: 20, right: 20, bottom: 100 })
    }
  }

  @Builder
  buildQuickActions() {
    Column() {
      Text('å¿«é€Ÿæ“ä½œ')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 15 })
      
      Grid() {
        // è¯¾ç¨‹ç®¡ç†
        GridItem() {
          this.buildActionCard('ðŸ“š', 'æˆ‘çš„è¯¾ç¨‹', 'æŸ¥çœ‹å’Œç®¡ç†è¯¾ç¨‹', () => {
            router.pushUrl({ url: 'pages/CourseListPage' });
          })
        }
        
        // æµ‹éªŒä½œä¸š
        GridItem() {
          this.buildActionCard('ðŸ“', 'æµ‹éªŒä½œä¸š', 'æŸ¥çœ‹æµ‹éªŒå’Œä½œä¸š', () => {
            router.pushUrl({ url: 'pages/QuizListPage' });
          })
        }
        
        // å­¦ä¹ è¿›åº¦
        GridItem() {
          this.buildActionCard('ðŸ“Š', 'å­¦ä¹ è¿›åº¦', 'æŸ¥çœ‹å­¦ä¹ ç»Ÿè®¡', () => {
            // TODO: è·³è½¬åˆ°å­¦ä¹ è¿›åº¦é¡µé¢
          })
        }
        
        // ç”¨æˆ·ç®¡ç†ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
        if (this.currentUser?.role === 'admin') {
          GridItem() {
            this.buildActionCard('ðŸ‘¥', 'ç”¨æˆ·ç®¡ç†', 'ç®¡ç†ç³»ç»Ÿç”¨æˆ·', () => {
              router.pushUrl({ url: 'pages/UserManagePage' });
            })
          }
        }
      }
      .columnsTemplate('1fr 1fr')
      .rowsTemplate('1fr 1fr')
      .columnsGap(15)
      .rowsGap(15)
    }
    .margin({ bottom: 30 })
  }

  @Builder
  buildActionCard(icon: string, title: string, desc: string, onClick: () => void) {
    Column() {
      Text(icon)
        .fontSize(32)
        .margin({ bottom: 10 })
      
      Text(title)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 5 })
      
      Text(desc)
        .fontSize(12)
        .fontColor('#666')
        .textAlign(TextAlign.Center)
    }
    .width('100%')
    .height(120)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .justifyContent(FlexAlign.Center)
    .onClick(onClick)
  }

  @Builder
  buildRecommendations() {
    Column() {
      Row() {
        Text('AIå­¦ä¹ æŽ¨è')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .flexGrow(1)
        
        Button('æ›´å¤š')
          .fontSize(14)
          .backgroundColor(Color.Transparent)
          .fontColor('#007AFF')
          .onClick(() => {
            // TODO: è·³è½¬åˆ°æŽ¨èé¡µé¢
          })
      }
      .margin({ bottom: 15 })
      
      if (this.recommendations.length > 0) {
        Column() {
          ForEach(this.recommendations.slice(0, 3), (item: LearningRecommendation) => {
            this.buildRecommendationItem(item)
          })
        }
      } else {
        Text('æš‚æ— æŽ¨èå†…å®¹')
          .fontSize(14)
          .fontColor('#999')
          .textAlign(TextAlign.Center)
          .padding({ top: 20, bottom: 20 })
      }
    }
    .margin({ bottom: 30 })
  }

  @Builder
  buildRecommendationItem(item: LearningRecommendation) {
    Row() {
      Column() {
        Text(item.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .margin({ bottom: 5 })
        
        Text(item.description)
          .fontSize(14)
          .fontColor('#666')
          .margin({ bottom: 5 })
        
        Text(item.reason)
          .fontSize(12)
          .fontColor('#999')
      }
      .alignItems(HorizontalAlign.Start)
      .flexGrow(1)
      
      Button('æŸ¥çœ‹')
        .fontSize(12)
        .height(30)
        .backgroundColor('#007AFF')
        .borderRadius(15)
        .onClick(() => {
          // TODO: è·³è½¬åˆ°æŽ¨èå†…å®¹
        })
    }
    .width('100%')
    .padding(15)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .margin({ bottom: 10 })
    .justifyContent(FlexAlign.SpaceBetween)
  }

  @Builder
  buildRecentActivity() {
    Column() {
      Text('æœ€è¿‘æ´»åŠ¨')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 15 })
      
      if (this.recentSubmissions.length > 0) {
        Column() {
          ForEach(this.recentSubmissions.slice(0, 5), (item: QuizSubmission) => {
            this.buildActivityItem(item)
          })
        }
      } else {
        Text('æš‚æ— æœ€è¿‘æ´»åŠ¨')
          .fontSize(14)
          .fontColor('#999')
          .textAlign(TextAlign.Center)
          .padding({ top: 20, bottom: 20 })
      }
    }
  }

  @Builder
  buildActivityItem(item: QuizSubmission) {
    Row() {
      Text('ðŸ“')
        .fontSize(20)
        .margin({ right: 15 })
      
      Column() {
        Text(`æäº¤äº†æµ‹éªŒ`)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
        
        Text(`å¾—åˆ†ï¼š${item.totalScore}åˆ†`)
          .fontSize(12)
          .fontColor('#666')
      }
      .alignItems(HorizontalAlign.Start)
      .flexGrow(1)
      
      Text(this.formatTime(item.submittedTime))
        .fontSize(12)
        .fontColor('#999')
    }
    .width('100%')
    .padding(15)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .margin({ bottom: 10 })
  }

  @Builder
  buildCourseTab() {
    Column() {
      Text('è¯¾ç¨‹åŠŸèƒ½å¼€å‘ä¸­...')
        .fontSize(16)
        .fontColor('#666')
        .textAlign(TextAlign.Center)
        .margin({ top: 100 })
    }
  }

  @Builder
  buildQuizTab() {
    Column() {
      Text('æµ‹éªŒåŠŸèƒ½å¼€å‘ä¸­...')
        .fontSize(16)
        .fontColor('#666')
        .textAlign(TextAlign.Center)
        .margin({ top: 100 })
    }
  }

  @Builder
  buildProfileTab() {
    Column() {
      Text('ä¸ªäººä¸­å¿ƒåŠŸèƒ½å¼€å‘ä¸­...')
        .fontSize(16)
        .fontColor('#666')
        .textAlign(TextAlign.Center)
        .margin({ top: 100 })
    }
  }

  @Builder
  buildBottomNav() {
    Row() {
      this.buildNavItem('ðŸ ', 'é¦–é¡µ', 0)
      this.buildNavItem('ðŸ“š', 'è¯¾ç¨‹', 1)
      this.buildNavItem('ðŸ“', 'æµ‹éªŒ', 2)
      this.buildNavItem('ðŸ‘¤', 'æˆ‘çš„', 3)
    }
    .width('100%')
    .height(60)
    .backgroundColor(Color.White)
    .border({ width: { top: 1 }, color: '#e0e0e0' })
    .position({ x: 0, y: '100%' })
    .translate({ y: -60 })
  }

  @Builder
  buildNavItem(icon: string, label: string, index: number) {
    Column() {
      Text(icon)
        .fontSize(20)
        .fontColor(this.currentTab === index ? '#007AFF' : '#666')
      
      Text(label)
        .fontSize(12)
        .fontColor(this.currentTab === index ? '#007AFF' : '#666')
        .margin({ top: 2 })
    }
    .flexGrow(1)
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.currentTab = index;
    })
  }

  loadRecommendations() {
    if (this.currentUser?.role === 'student') {
      this.recommendations = getActiveRecommendations(this.currentUser.id);
    }
  }

  loadRecentSubmissions() {
    if (this.currentUser?.role === 'student') {
      this.recentSubmissions = getStudentSubmissions(this.currentUser.id);
    }
  }

  formatTime(timeStr: string): string {
    const date = new Date(timeStr);
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    if (days === 0) {
      return 'ä»Šå¤©';
    } else if (days === 1) {
      return 'æ˜¨å¤©';
    } else if (days < 7) {
      return `${days}å¤©å‰`;
    } else {
      return date.toLocaleDateString();
    }
  }
} 