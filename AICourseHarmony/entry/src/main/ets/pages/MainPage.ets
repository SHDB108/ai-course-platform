import router from '@ohos.router';
import { getCurrentUser } from '../common/UserStore';
import { UserInfo, UserRole } from '../common/UserTypes';
import { getEnrolledCourses, getAllCourses, getCoursesByTeacher } from '../common/CourseStore';
import { Course } from '../common/CourseTypes';
import { getStudentSubmissions, getAllQuizzes } from '../common/QuizStore';
import { Quiz, QuizSubmission } from '../common/QuizTypes';
import { getActiveRecommendations, LearningRecommendation } from '../common/LearningStore';

interface QuickAction {
  icon: string;
  title: string;
  desc: string;
  onClick: () => void;
}

interface NavItem {
  icon: string;
  label: string;
  index: number;
}

// ä¸»é¡µé¢ï¼ŒAIè¯¾ç¨‹å¹³å°çš„æ ¸å¿ƒå¯¼èˆªä¸åŠŸèƒ½å…¥å£
// åŒ…å«è¯¾ç¨‹ã€æµ‹éªŒã€å­¦ä¹ è¿›åº¦ã€ç”¨æˆ·ç®¡ç†ç­‰ä¸»è¦æ¨¡å—çš„å¯¼èˆªä¸å±•ç¤º

/**
 * ä¸»é¡µé¢ç»„ä»¶
 * æä¾›å¹³å°ä¸»è¦åŠŸèƒ½çš„å¯¼èˆªå…¥å£å’Œæ¦‚è§ˆ
 */
@Entry
@Component
struct MainPage {
  @State currentUser: UserInfo | null = getCurrentUser();
  @State courses: Course[] = [];
  @State recommendations: LearningRecommendation[] = [];
  @State submissions: QuizSubmission[] = [];
  @State recentSubmissions: QuizSubmission[] = [];
  @State currentTab: number = 0;
  @State navItems: NavItem[] = [
    { icon: 'ğŸ ', label: 'é¦–é¡µ', index: 0 },
    { icon: 'ğŸ“š', label: 'è¯¾ç¨‹', index: 1 },
    { icon: 'ğŸ“', label: 'æµ‹éªŒ', index: 2 },
    { icon: 'ğŸ‘¤', label: 'æˆ‘çš„', index: 3 }
  ];
  @State actions: QuickAction[] = [];
  @State quizzes: Quiz[] = [];

  aboutToAppear() {
    if (this.currentUser) {
      let actions: QuickAction[] = [];
      if (this.currentUser.role === 'admin') {
        actions = [
          { icon: 'ğŸ‘¥', title: 'ç”¨æˆ·ç®¡ç†', desc: 'ç®¡ç†ç³»ç»Ÿç”¨æˆ·', onClick: () => router.pushUrl({ url: 'pages/UserManagePage' }) },
          { icon: 'ğŸ“š', title: 'è¯¾ç¨‹ç®¡ç†', desc: 'ç®¡ç†æ‰€æœ‰è¯¾ç¨‹', onClick: () => router.pushUrl({ url: 'pages/CourseListPage' }) },
          { icon: 'ğŸ“', title: 'æµ‹éªŒç®¡ç†', desc: 'ç®¡ç†æ‰€æœ‰æµ‹éªŒ', onClick: () => router.pushUrl({ url: 'pages/QuizListPage' }) },
          { icon: 'ğŸ“Š', title: 'å­¦ä¹ è¿›åº¦', desc: 'æŸ¥çœ‹å…¨å‘˜å­¦ä¹ ç»Ÿè®¡', onClick: () => router.pushUrl({ url: 'pages/LearningProgressPage' }) },
          { icon: 'âš™ï¸', title: 'ç³»ç»Ÿè®¾ç½®', desc: 'å¹³å°å‚æ•°é…ç½®', onClick: () => router.pushUrl({ url: 'pages/SystemSettingPage' }) }
        ];
      } else if (this.currentUser.role === 'teacher') {
        actions = [
          { icon: 'ğŸ“š', title: 'è¯¾ç¨‹ç®¡ç†', desc: 'ç®¡ç†æˆ‘çš„è¯¾ç¨‹', onClick: () => router.pushUrl({ url: 'pages/CourseListPage' }) },
          { icon: 'ğŸ“', title: 'æµ‹éªŒç®¡ç†', desc: 'ç®¡ç†è¯¾ç¨‹æµ‹éªŒ', onClick: () => router.pushUrl({ url: 'pages/QuizListPage' }) },
          { icon: 'ğŸ“Š', title: 'å­¦ä¹ è¿›åº¦', desc: 'æŸ¥çœ‹å­¦ç”Ÿå­¦ä¹ ç»Ÿè®¡', onClick: () => router.pushUrl({ url: 'pages/LearningProgressPage' }) }
        ];
      } else if (this.currentUser.role === 'student') {
        actions = [
          { icon: 'ğŸ“š', title: 'æˆ‘çš„è¯¾ç¨‹', desc: 'æŸ¥çœ‹å’Œé€‰ä¿®è¯¾ç¨‹', onClick: () => router.pushUrl({ url: 'pages/CourseListPage' }) },
          { icon: 'ğŸ“', title: 'æµ‹éªŒä½œä¸š', desc: 'å‚åŠ æµ‹éªŒå’Œä½œä¸š', onClick: () => router.pushUrl({ url: 'pages/QuizListPage' }) },
          { icon: 'ğŸ“Š', title: 'å­¦ä¹ è¿›åº¦', desc: 'æŸ¥çœ‹æˆ‘çš„å­¦ä¹ ç»Ÿè®¡', onClick: () => router.pushUrl({ url: 'pages/LearningProgressPage' }) }
        ];
      }
      this.actions = actions;
      this.loadUserData();
      this.loadRecommendations();
      this.loadRecentSubmissions();
      this.loadQuizzes();
    }
  }

  onShow() {
    this.loadUserData();
  }

  loadUserData() {
    if (!this.currentUser) {
      router.replaceUrl({ url: 'pages/LoginPage' });
      return;
    }

    // æ ¹æ®ç”¨æˆ·è§’è‰²åŠ è½½ä¸åŒæ•°æ®
    if (this.currentUser.role === 'student') {
      this.courses = getEnrolledCourses(this.currentUser.id);
      this.recommendations = getActiveRecommendations(this.currentUser.id);
      this.submissions = getStudentSubmissions(this.currentUser.id);
    } else if (this.currentUser.role === 'teacher') {
      this.courses = getCoursesByTeacher(this.currentUser.id);
    } else if (this.currentUser.role === 'admin') {
      this.courses = getAllCourses();
    }
  }

  loadQuizzes() {
    this.quizzes = getAllQuizzes();
  }

  build() {
    Scroll() {
      Column() {
        this.buildHeader()
        if (this.currentTab === 0) {
          this.buildHomeTabContent()
        } else if (this.currentTab === 1) {
          this.buildCourseTab()
        } else if (this.currentTab === 2) {
          this.buildQuizTab()
        } else if (this.currentTab === 3) {
          this.buildProfileTab()
        }
        this.buildBottomNav()
      }
      .width('100%')
      .backgroundColor('#f5f5f5')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder
  buildHeader() {
    Row() {
      Column() {
        Text('AIè¯¾ç¨‹å¹³å°')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
        if (this.currentUser) {
          Text(`æ¬¢è¿ï¼Œ${this.currentUser.realName}`)
            .fontSize(14)
            .fontColor(Color.White)
            .opacity(0.8)
        }
      }
      .alignItems(HorizontalAlign.Start)
      .flexGrow(1)
      Button('è®¾ç½®')
        .fontSize(14)
        .backgroundColor(Color.Transparent)
        .fontColor(Color.White)
        .onClick(() => {
          router.pushUrl({ url: 'pages/SystemSettingPage' });
        })
    }
    .width('100%')
    .height(60)
    .backgroundColor('#007AFF')
  }

  @Builder
  buildHomeTabContent() {
    Column() {
      // å¿«é€Ÿæ“ä½œå¡ç‰‡
      if (this.currentUser) {
        this.buildQuickActions()
      }
      // AIå­¦ä¹ æ¨è
      this.buildRecommendations()
      // æœ€è¿‘æ´»åŠ¨
      this.buildRecentActivity()
      // è‡ªé€‚åº”ç©ºç™½å¡«å……
      if (this.actions.length < 5) {
        Text(' ')
          .height(300)
      } else {
        Text(' ')
          .height(30)
      }
    }
    .padding({ left: 20, right: 20, bottom: 30 })
  }

  @Builder
  buildQuickActions() {
    Column() {
      Text('å¿«é€Ÿæ“ä½œ')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 15 })
      List() {
        ForEach(this.actions, (action: QuickAction, index: number) => {
        ListItem() {
            Button(action.title)
              .width('100%')
              .height(56)
              .margin({ top: 6, bottom: 6 })
              .onClick(action.onClick)
          }
        })
      }
    }
    .margin({ bottom: 30 })
  }

  @Builder
  buildRecommendations() {
    Column() {
      Row() {
        Text('AIå­¦ä¹ æ¨è')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .flexGrow(1)
        
        Button('æ›´å¤š')
          .fontSize(14)
          .backgroundColor(Color.Transparent)
          .fontColor('#007AFF')
          .onClick(() => {
            // TODO: è·³è½¬åˆ°æ¨èé¡µé¢
          })
      }
      .margin({ bottom: 15 })
      
      if (this.recommendations.length > 0) {
        Column() {
          ForEach(this.recommendations.slice(0, 3), (item: LearningRecommendation) => {
            this.buildRecommendationItem(item)
          })
        }
      } else {
        Text('æš‚æ— æ¨èå†…å®¹')
          .fontSize(14)
          .fontColor('#999')
          .textAlign(TextAlign.Center)
          .padding({ top: 20, bottom: 20 })
      }
    }
    .margin({ bottom: 30 })
  }

  @Builder
  buildRecommendationItem(item: LearningRecommendation) {
    Row() {
      Column() {
        Text(item.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .margin({ bottom: 5 })
        
        Text(item.description)
          .fontSize(14)
          .fontColor('#666')
          .margin({ bottom: 5 })
        
        Text(item.reason)
          .fontSize(12)
          .fontColor('#999')
      }
      .alignItems(HorizontalAlign.Start)
      .flexGrow(1)
      
      Button('æŸ¥çœ‹')
        .fontSize(12)
        .height(30)
        .backgroundColor('#007AFF')
        .borderRadius(15)
        .onClick(() => {
          // TODO: è·³è½¬åˆ°æ¨èå†…å®¹
        })
    }
    .width('100%')
    .padding(15)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .margin({ bottom: 10 })
    .justifyContent(FlexAlign.SpaceBetween)
  }

  @Builder
  buildRecentActivity() {
    Column() {
      Text('æœ€è¿‘æ´»åŠ¨')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 15 })
      
      if (this.recentSubmissions.length > 0) {
        Column() {
          ForEach(this.recentSubmissions.slice(0, 5), (item: QuizSubmission) => {
            this.buildActivityItem(item)
          })
        }
      } else {
        Text('æš‚æ— æœ€è¿‘æ´»åŠ¨')
          .fontSize(14)
          .fontColor('#999')
          .textAlign(TextAlign.Center)
          .padding({ top: 20, bottom: 20 })
      }
    }
  }

  @Builder
  buildActivityItem(item: QuizSubmission) {
    Row() {
      Text('ğŸ“')
        .fontSize(20)
        .margin({ right: 15 })
      
      Column() {
        Text(`æäº¤äº†æµ‹éªŒ`)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
        
        Text(`å¾—åˆ†ï¼š${item.totalScore}åˆ†`)
          .fontSize(12)
          .fontColor('#666')
      }
      .alignItems(HorizontalAlign.Start)
      .flexGrow(1)
      
      Text(this.formatTime(item.submittedTime))
        .fontSize(12)
        .fontColor('#999')
    }
    .width('100%')
    .padding(15)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .margin({ bottom: 10 })
  }

  @Builder
  buildCourseTab() {
    Column() {
      if (this.currentUser) {
        if (this.currentUser.role === 'admin') {
          Button('+ æ–°å»ºè¯¾ç¨‹')
            .width('100%')
            .height(50)
            .backgroundColor('#007AFF')
            .fontColor(Color.White)
            .fontSize(16)
            .margin({ top: 20, bottom: 20 })
            .onClick(() => {
              router.pushUrl({ url: 'pages/EditCoursePage' });
            })
          this.buildCourseList('all')
        } else if (this.currentUser.role === 'teacher') {
          Button('+ æ–°å»ºè¯¾ç¨‹')
            .width('100%')
            .height(50)
            .backgroundColor('#007AFF')
            .fontColor(Color.White)
            .fontSize(16)
            .margin({ top: 20, bottom: 20 })
            .onClick(() => {
              router.pushUrl({ url: 'pages/EditCoursePage' });
            })
          this.buildCourseList('teacher')
        } else if (this.currentUser.role === 'student') {
          Button('é€‰ä¿®æ–°è¯¾ç¨‹')
            .width('100%')
            .height(50)
            .backgroundColor('#007AFF')
            .fontColor(Color.White)
            .fontSize(16)
            .margin({ top: 20, bottom: 20 })
            .onClick(() => {
              router.pushUrl({ url: 'pages/CourseListPage' });
            })
          this.buildCourseList('student')
        }
        // è‡ªé€‚åº”ç©ºç™½å¡«å……
        if (this.courses.length < 5) {
          Text(' ')
            .height(300)
        } else {
          Text(' ')
            .height(30)
        }
      } else {
        Text('è¯·å…ˆç™»å½•')
          .fontSize(16)
          .fontColor('#666')
          .textAlign(TextAlign.Center)
          .margin({ top: 100 })
      }
    }
  }

  @Builder
  buildQuizTab() {
    Column() {
      if (this.currentUser) {
        if (this.currentUser.role === 'admin') {
          Button('+ æ–°å»ºæµ‹éªŒ')
            .width('100%')
            .height(50)
            .backgroundColor('#007AFF')
            .fontColor(Color.White)
            .fontSize(16)
            .margin({ top: 20, bottom: 20 })
            .onClick(() => {
              router.pushUrl({ url: 'pages/EditQuizPage' });
            })
          this.buildQuizList('all')
        } else if (this.currentUser.role === 'teacher') {
          Button('+ æ–°å»ºæµ‹éªŒ')
            .width('100%')
            .height(50)
            .backgroundColor('#007AFF')
            .fontColor(Color.White)
            .fontSize(16)
            .margin({ top: 20, bottom: 20 })
            .onClick(() => {
              router.pushUrl({ url: 'pages/EditQuizPage' });
            })
          this.buildQuizList('teacher')
        } else if (this.currentUser.role === 'student') {
          this.buildQuizList('student')
        }
        // è‡ªé€‚åº”ç©ºç™½å¡«å……
        if (this.submissions.length < 5) {
          Text(' ')
            .height(300)
        } else {
          Text(' ')
            .height(30)
        }
      } else {
        Text('è¯·å…ˆç™»å½•')
          .fontSize(16)
          .fontColor('#666')
          .textAlign(TextAlign.Center)
          .margin({ top: 100 })
      }
    }
  }

  @Builder
  buildProfileTab() {
    Column() {
      if (this.currentUser) {
        Text('ä¸ªäººä¸­å¿ƒ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 30, bottom: 20 })
        Text(`è§’è‰²ï¼š${this.getRoleText(this.currentUser.role)}`)
          .fontSize(14)
          .fontColor('#666')
          .margin({ bottom: 20 })
        Button('ä¸ªäººä¿¡æ¯')
          .width('100%')
          .height(50)
          .backgroundColor('#f0f0f0')
          .fontColor('#333')
          .fontSize(16)
          .margin({ bottom: 15 })
          .onClick(() => {
            router.pushUrl({ url: 'pages/UserInfoPage' });
          })
        Button('ç³»ç»Ÿè®¾ç½®')
          .width('100%')
          .height(50)
          .backgroundColor('#f0f0f0')
          .fontColor('#333')
          .fontSize(16)
          .margin({ bottom: 15 })
          .onClick(() => {
            router.pushUrl({ url: 'pages/SystemSettingPage' });
          })
        Button('é€€å‡ºç™»å½•')
          .width('100%')
          .height(50)
          .backgroundColor('#FF3B30')
          .fontColor(Color.White)
          .fontSize(16)
          .margin({ bottom: 15 })
          .onClick(() => {
            router.replaceUrl({ url: 'pages/LoginPage' });
          })
        // è‡ªé€‚åº”ç©ºç™½å¡«å……
        Text(' ')
          .height(300)
      } else {
        Text('è¯·å…ˆç™»å½•')
          .fontSize(16)
          .fontColor('#666')
          .textAlign(TextAlign.Center)
          .margin({ top: 100 })
      }
    }
  }

  @Builder
  buildBottomNav() {
    Row() {
      Column() {
        Text('ğŸ ')
          .fontSize(20)
          .fontColor(this.currentTab === 0 ? '#007AFF' : '#666')
        Text('é¦–é¡µ')
          .fontSize(12)
          .fontColor(this.currentTab === 0 ? '#007AFF' : '#666')
          .margin({ top: 2 })
      }
      .flexGrow(1)
      .justifyContent(FlexAlign.Center)
      .onClick(() => { this.currentTab = 0 })

      Column() {
        Text('ğŸ“š')
          .fontSize(20)
          .fontColor(this.currentTab === 1 ? '#007AFF' : '#666')
        Text('è¯¾ç¨‹')
          .fontSize(12)
          .fontColor(this.currentTab === 1 ? '#007AFF' : '#666')
          .margin({ top: 2 })
      }
      .flexGrow(1)
      .justifyContent(FlexAlign.Center)
      .onClick(() => { this.currentTab = 1 })

      Column() {
        Text('ğŸ“')
          .fontSize(20)
          .fontColor(this.currentTab === 2 ? '#007AFF' : '#666')
        Text('æµ‹éªŒ')
          .fontSize(12)
          .fontColor(this.currentTab === 2 ? '#007AFF' : '#666')
          .margin({ top: 2 })
      }
      .flexGrow(1)
      .justifyContent(FlexAlign.Center)
      .onClick(() => { this.currentTab = 2 })

      Column() {
        Text('ğŸ‘¤')
          .fontSize(20)
          .fontColor(this.currentTab === 3 ? '#007AFF' : '#666')
        Text('æˆ‘çš„')
          .fontSize(12)
          .fontColor(this.currentTab === 3 ? '#007AFF' : '#666')
          .margin({ top: 2 })
      }
      .flexGrow(1)
      .justifyContent(FlexAlign.Center)
      .onClick(() => { this.currentTab = 3 })
    }
    .width('100%')
    .height(60)
    .backgroundColor(Color.White)
    .border({ width: { top: 1 }, color: '#e0e0e0' })
  }

  loadRecommendations() {
    if (this.currentUser?.role === 'student') {
      this.recommendations = getActiveRecommendations(this.currentUser.id);
    }
  }

  loadRecentSubmissions() {
    if (this.currentUser?.role === 'student') {
      this.recentSubmissions = getStudentSubmissions(this.currentUser.id);
    }
  }

  formatTime(timeStr: string): string {
    const date = new Date(timeStr);
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    if (days === 0) {
      return 'ä»Šå¤©';
    } else if (days === 1) {
      return 'æ˜¨å¤©';
    } else if (days < 7) {
      return `${days}å¤©å‰`;
    } else {
      return date.toLocaleDateString();
    }
  }

  @Builder
  buildCourseList(type: string) {
    // è¿™é‡Œåªåšç®€å•æ¼”ç¤ºï¼Œå®é™…å¯æ ¹æ®typeç­›é€‰ä¸åŒè¯¾ç¨‹
    Column() {
      Text(type === 'all' ? 'å…¨éƒ¨è¯¾ç¨‹åˆ—è¡¨' : type === 'teacher' ? 'æˆ‘çš„è¯¾ç¨‹åˆ—è¡¨' : 'å·²é€‰è¯¾ç¨‹åˆ—è¡¨')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 10 })
      ForEach(this.courses, (course: Course) => {
        Row() {
          Text(course.name)
            .fontSize(14)
            .margin({ right: 10 })
          Text(course.teacherName)
            .fontSize(12)
            .fontColor('#666')
        }
        .margin({ bottom: 8 })
      })
    }
    .padding({ left: 20, right: 20 })
  }

  @Builder
  buildQuizList(type: string) {
    Column() {
      Text(type === 'all' ? 'å…¨éƒ¨æµ‹éªŒåˆ—è¡¨' : type === 'teacher' ? 'è¯¾ç¨‹æµ‹éªŒåˆ—è¡¨' : 'å¯å‚åŠ çš„æµ‹éªŒåˆ—è¡¨')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 10 })
      ForEach(this.quizzes, (quiz: Quiz) => {
        Row() {
          Text(quiz.title)
            .fontSize(14)
            .margin({ right: 10 })
          Text(quiz.type === 'quiz' ? 'æµ‹éªŒ' : 'ä½œä¸š')
            .fontSize(12)
            .fontColor('#666')
        }
        .margin({ bottom: 8 })
      })
    }
    .padding({ left: 20, right: 20 })
  }

  getRoleText(role: string): string {
    switch (role) {
      case 'admin':
        return 'ç³»ç»Ÿç®¡ç†å‘˜';
      case 'teacher':
        return 'æ•™å¸ˆ';
      case 'student':
        return 'å­¦ç”Ÿ';
      default:
        return 'æœªçŸ¥';
    }
  }
} 