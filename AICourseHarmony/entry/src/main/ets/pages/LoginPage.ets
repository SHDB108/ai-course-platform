import router from '@ohos.router';
import { login, UserInfo } from '../common/UserStore';

@Entry
@Component
struct LoginPage {
  @State username: string = ''
  @State password: string = ''
  @State errorMsg: string = ''
  @State isLoading: boolean = false
  @State showPassword: boolean = false

  build() {
    Column() {
      // é¡¶éƒ¨è¿”å›æŒ‰é’®
      Row() {
        Button('â† è¿”å›')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            router.back();
          })
      }
      .width('100%')
      .padding({ left: 20, top: 20, bottom: 20 })
      .justifyContent(FlexAlign.Start)

      // ç™»å½•è¡¨å•
      Column() {
        // Logoå’Œæ ‡é¢˜
        Column() {
          Image($r('app.media.foreground'))
            .width(80)
            .height(80)
            .margin({ bottom: 20 })
          
          Text('AIè¯¾ç¨‹å¹³å°')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 8 })
          
          Text('æ™ºèƒ½åŒ–ç”Ÿäº§ Â· ç»“æ„åŒ–ç®¡ç† Â· ä¸ªæ€§åŒ–å­¦ä¹ ')
            .fontSize(14)
            .fontColor('#666')
            .margin({ bottom: 40 })
        }
        .alignItems(HorizontalAlign.Center)

        // ç™»å½•è¡¨å•
        Column() {
          // ç”¨æˆ·åè¾“å…¥æ¡†
          Column() {
            Text('ç”¨æˆ·å')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })
            
            TextInput({ 
              placeholder: 'è¯·è¾“å…¥ç”¨æˆ·å', 
              text: this.username 
            })
              .onChange((value: string) => this.username = value)
              .height(50)
              .backgroundColor('#f8f9fa')
              .borderRadius(8)
              .padding({ left: 15, right: 15 })
              .placeholderColor('#999')
          }
          .margin({ bottom: 20 })

          // å¯†ç è¾“å…¥æ¡†
          Column() {
            Text('å¯†ç ')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })
            
            Row() {
              TextInput({ 
                placeholder: 'è¯·è¾“å…¥å¯†ç ', 
                text: this.password 
              })
                .onChange((value: string) => this.password = value)
                .type(this.showPassword ? InputType.Normal : InputType.Password)
                .height(50)
                .backgroundColor('#f8f9fa')
                .borderRadius(8)
                .padding({ left: 15, right: 15 })
                .placeholderColor('#999')
                .flexGrow(1)
              
              Button(this.showPassword ? 'ğŸ‘ï¸' : 'ğŸ™ˆ')
                .width(50)
                .height(50)
                .backgroundColor('#f8f9fa')
                .borderRadius(8)
                .margin({ left: 10 })
                .onClick(() => {
                  this.showPassword = !this.showPassword;
                })
            }
          }
          .margin({ bottom: 20 })

          // é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
          if (this.errorMsg !== '') {
            Text(this.errorMsg)
              .fontSize(14)
              .fontColor(Color.Red)
              .margin({ bottom: 20 })
          }

          // ç™»å½•æŒ‰é’®
          Button(this.isLoading ? 'ç™»å½•ä¸­...' : 'ç™»å½•')
            .width('100%')
            .height(50)
            .backgroundColor(this.isLoading ? '#ccc' : '#007AFF')
            .borderRadius(8)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor(Color.White)
            .onClick(() => {
              this.handleLogin();
            })
            .enabled(!this.isLoading)

          // å¿«é€Ÿç™»å½•æç¤º
          Column() {
            Text('æµ‹è¯•è´¦å·')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .margin({ top: 30, bottom: 15 })
            
            this.buildTestAccount('ç®¡ç†å‘˜', 'admin', 'admin123')
            this.buildTestAccount('æ•™å¸ˆ', 'teacher1', 'teacher123')
            this.buildTestAccount('å­¦ç”Ÿ', 'student1', 'student123')
          }
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%')
        .padding({ left: 30, right: 30 })
      }
      .flexGrow(1)
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
  }

  @Builder
  buildTestAccount(role: string, username: string, password: string) {
    Row() {
      Text(`${role}: ${username}`)
        .fontSize(12)
        .fontColor('#666')
        .flexGrow(1)
      
      Button('ä½¿ç”¨')
        .fontSize(12)
        .height(30)
        .backgroundColor('#f0f0f0')
        .borderRadius(15)
        .onClick(() => {
          this.username = username;
          this.password = password;
        })
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceBetween)
    .margin({ bottom: 8 })
  }

  handleLogin() {
    // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
    this.errorMsg = '';
    
    // éªŒè¯è¾“å…¥
    if (!this.username.trim()) {
      this.errorMsg = 'è¯·è¾“å…¥ç”¨æˆ·å';
      return;
    }
    
    if (!this.password.trim()) {
      this.errorMsg = 'è¯·è¾“å…¥å¯†ç ';
      return;
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    this.isLoading = true;

    // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    setTimeout(() => {
      try {
        const user = login(this.username.trim(), this.password.trim());
        
        if (user) {
          // ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°ä¸»é¡µé¢
          router.replaceUrl({ url: 'pages/MainPage' });
        } else {
          // ç™»å½•å¤±è´¥
          this.errorMsg = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
        }
      } catch (error) {
        this.errorMsg = 'ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
      } finally {
        this.isLoading = false;
      }
    }, 1000);
  }
} 